<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180.png"> 
    <link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon--192.png"> 
    <link rel="apple-touch-icon" sizes="512x512" href="/apple-touch-icon--512.png">
	<title>åˆ†å¸³è¨˜å¸³ç°¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* ä¿®æ­£ï¼šç§»é™¤è¼¸å…¥æ¡†åŸç”Ÿçš„å¢æ¸›æ§åˆ¶é … */
        input[type='number'] {
            -moz-appearance: textfield;
        }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* âœ¨ NEW: ä¿®æ­£ Modal é–ƒçˆå•é¡Œï¼Œé‡å° Safari/WebKit å„ªåŒ– */
        .force-gpu {
            /* è®“ç€è¦½å™¨æ¨åˆ°ç¨ç«‹åœ–å±¤ï¼Œè§£æ±ºèƒŒæ™¯é–ƒçˆ */
            transform: translateZ(0);
            /* å‘Šè¨´ç€è¦½å™¨æº–å‚™è®ŠåŒ–ï¼Œé¿å…é‡æ–°è¨ˆç®— */
            will-change: transform; 
        }
    </style>
    
    <script>
        // è¨­å®š Tailwind CSS é¡è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primaryColor: {
                            500: '#14b8a6', // teal-500
                            600: '#0d9488', // teal-600
                            700: '#0f766e', // teal-700
                        },
                    },
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script>
        // ä¿®æ­£ï¼šå°‡é€™äº›è®Šæ•¸å®šç¾©åœ¨ç´” JS å€å¡Šï¼Œä½¿ Babel è…³æœ¬å¯ä»¥è¨ªå•
        const __app_id = "YOUR_APP_ID"; // ä¾‹å¦‚: 'my-splitwise-app-2025'
        // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½® JSON
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyANDhJ--MDYI5SfsHOuuQwVM0sYMM91UFM",
            authDomain: "splite-expense-tracker-multi.firebaseapp.com",
            projectId: "splite-expense-tracker-multi",
            storageBucket: "splite-expense-tracker-multi.firebasestorage.app",
            messagingSenderId: "10696910340",
            appId: "1:425612895494:web:b5889f1d83cafb41d7ea87",
            measurementId: "G-XCB90NSB43"
        });
        // åŒ¿åç™»å…¥ä¸å†ä½¿ç”¨ï¼Œæ•…ä¸éœ€è¦ __initial_auth_token

        // æ–°å¢ï¼šè«‹å°‡æ‚¨çš„ Gemini API Key å¡«å…¥æ­¤è™•ï¼ˆç›®å‰æœªä½¿ç”¨ï¼‰
        const GEMINI_API_KEY = ""; 
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    
<script type="text/babel">
        const React = window.React;
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // å°‡å…¨åŸŸè®Šæ•¸å¼•å…¥ Babel ä½œç”¨åŸŸï¼Œä¸¦çµ±ä¸€ä½¿ç”¨æˆªåœ–ä¸­çš„ ID
        const appId = "YOUR_APP_ID"; 
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        const { firestore } = firebase;
        const serverTimestamp = firestore.FieldValue.serverTimestamp; 
        
        // è·¯å¾‘å‡½æ•¸ï¼šçµ±ä¸€ä½¿ç”¨ YOUR_APP_ID
        const getGroupExpensesPath = (groupId) => `artifacts/${appId}/groups/${groupId}/expenses`;
        const getGroupMembersDocPath = (groupId) => `artifacts/${appId}/groups/${groupId}/settings/members`;
        const getGroupDocPath = (groupId) => `artifacts/${appId}/groups/${groupId}`;

        // --- åŒ¯ç‡èˆ‡å·¥å…·å‡½æ•¸ä¿ç•™ (çœç•¥é‡è¤‡éƒ¨åˆ†ä»¥ç¸®çŸ­ç¯‡å¹…) ---
        const PERMANENT_RATES_CACHE_KEY = "permanentExchangeRates";
        const HARDCODED_DEFAULT_RATES = { 'TWD': 1.0, 'CNY': 4.5, 'USD': 30.5, 'THB': 0.85, 'EUR': 33.0, 'CAD': 22.5, 'VND': 0.0013, 'IDR': 0.002, 'JPY': 0.25, 'KRW': 0.023, 'AUD': 20.0, 'NOK': 2.9 };
        let DEFAULT_EXCHANGE_RATES = HARDCODED_DEFAULT_RATES;
        const CURRENCIES = Object.keys(HARDCODED_DEFAULT_RATES);
        const DEFAULT_CURRENCY = 'TWD';
        const fetchExchangeRates = async () => { /* ...åŸæœ¬çš„ fetchExchangeRates... */ return {rates: DEFAULT_EXCHANGE_RATES, lastUpdate: Date.now()}; };
        const generateShortCode = (length = 6) => { /* ...åŸæœ¬çš„ç”¢ç”Ÿå™¨... */ return Math.random().toString(36).substr(2, length).toUpperCase(); };

        // --- SVG åœ–æ¨™çµ„ä»¶ä¿ç•™ ---
        const IconProps = { stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", fill: "none" };
        const CircleDollarSign = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const Trash2 = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const Plus = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>;
        const Minus = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M5 12h14"/></svg>;
        const Users = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const X = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>;
        const CircleCheck = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14 9 11"/></svg>;
        const Pencil = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const UserMinus = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="22" x2="16" y1="11" y2="11"/></svg>;
        const LogOut = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
        const Share2 = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.42" x2="8.59" y1="6.51" y2="10.49"/></svg>;
        const Search = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>;

        const createOrUpdatePublicProfile = async (db, uid, displayName, email) => {
            if (!db || !uid) return;
            try {
                await db.doc(`artifacts/${appId}/public_profiles/${uid}`).set({ displayName, email, uid }, { merge: true });
            } catch (e) { console.error("Profile Error:", e); }
        };

        /**
         * App å…ƒä»¶
         */
        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [authReady, setAuthReady] = useState(false);
            const [isGuest, setIsGuest] = useState(false);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            const [userProfiles, setUserProfiles] = useState({});
            const [liveExchangeRates, setLiveExchangeRates] = useState(DEFAULT_EXCHANGE_RATES);
            const [lastExchangeUpdate, setLastExchangeUpdate] = useState(null);
            const [copyMessage, setCopyMessage] = useState('');
            const [currentCollectionId, setCurrentCollectionId] = useState(null);
            const [currentCollectionShortCode, setCurrentCollectionShortCode] = useState(null);
            const [groupOwner, setGroupOwner] = useState(null);
            const [groupMembers, setGroupMembers] = useState([]);
            const [groupName, setGroupName] = useState('åˆ†å¸³è¨˜å¸³ç°¿');
            const [expenses, setExpenses] = useState([]);
            const [customMembers, setCustomMembers] = useState([]);
            const [defaultSharesConfig, setDefaultSharesConfig] = useState({});
            const [members, setMembers] = useState([]);
            const [error, setError] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [searchKeyword, setSearchKeyword] = useState('');

            const isReadOnly = isGuest || (userId && groupMembers.length > 0 && !groupMembers.includes(userId));

            const setToastMessage = useCallback((msg) => {
                setCopyMessage(msg);
                if (msg) setTimeout(() => setCopyMessage(''), 4000);
            }, []);

            const ensureDefaultGroup = useCallback(async (_db, uid) => {
                if (!_db || !uid) return null;
                const groupRef = _db.doc(getGroupDocPath(uid));
                const snap = await groupRef.get();
                if (!snap.exists) {
                    await groupRef.set({
                        owner: uid,
                        members: [uid],
                        createdAt: serverTimestamp(),
                        name: 'æˆ‘çš„åˆ†å¸³è¨˜å¸³ç°¿',
                    });
                }
                return uid;
            }, []);

            // --- 1. Firebase åˆå§‹åŒ–èˆ‡æ¬Šé™æµç¨‹ä¿®æ­£ ---
            useEffect(() => {
                if (!firebaseConfig) { setError('Firebase Config Missing'); setAuthReady(true); return; }
                const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
                const _auth = app.auth();
                const _db = app.firestore();
                setDb(_db); setAuth(_auth);

                const unsubscribe = _auth.onAuthStateChanged(async (user) => {
                    try {
                        if (user) {
                            console.log("ğŸ‘¤ ç™»å…¥ç”¨æˆ¶:", user.uid);
                            setUserId(user.uid);
                            setIsGuest(user.isAnonymous);

                            // å…ˆç¢ºä¿ç¾¤çµ„å­˜åœ¨ (é—œéµä¿®å¾©ï¼šé˜²æ­¢æ–°å¸³è™Ÿ Permission Denied)
                            if (!user.isAnonymous) {
                                await ensureDefaultGroup(_db, user.uid);
                            }

                            const usersRef = _db.collection(`artifacts/${appId}/users`);
                            let targetId = user.uid;
                            let targetCode = null;

                            // è§£æ URL çŸ­ä»£ç¢¼
                            const path = window.location.pathname;
                            const marker = '/g/';
                            if (path.includes(marker)) {
                                const code = path.split(marker)[1].split('/')[0];
                                const snap = await usersRef.where('shortCode', '==', code).limit(1).get();
                                if (!snap.empty) {
                                    targetId = snap.docs[0].id;
                                    targetCode = code;
                                }
                            }

                            setCurrentCollectionId(targetId);
                            setCurrentCollectionShortCode(targetCode);
                        } else {
                            await _auth.signInAnonymously();
                        }
                    } catch (e) {
                        console.error("Auth Init Error:", e);
                    } finally {
                        setAuthReady(true);
                    }
                });
                return () => unsubscribe();
            }, [ensureDefaultGroup]);

            // --- 2. ç›£è½ Firestore è³‡æ–™ (åŠ å…¥å»¶é²å•Ÿå‹•ï¼Œç¢ºä¿ ID å·²ç©©å®š) ---
            useEffect(() => {
                if (!authReady || !db || !currentCollectionId) return;

                const expensesRef = db.collection(getGroupExpensesPath(currentCollectionId));
                const unsubExpenses = expensesRef.onSnapshot(
                    (snap) => {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate() }));
                        setExpenses(data);
                        setError(null);
                    },
                    (err) => {
                        if (err.code === 'permission-denied' && currentCollectionId !== userId) {
                            setError(`æ¬Šé™ä¸è¶³ï¼šç„¡æ³•è®€å–æ­¤ç´€éŒ„ç°¿ (ID: ${currentCollectionId})`);
                        }
                    }
                );

                const groupRef = db.doc(getGroupDocPath(currentCollectionId));
                const unsubGroup = groupRef.onSnapshot((snap) => {
                    if (snap.exists) {
                        const d = snap.data();
                        setGroupOwner(d.owner);
                        setGroupMembers(d.members || []);
                        setGroupName(d.name || 'åˆ†å¸³è¨˜å¸³ç°¿');
                    }
                });

                const membersRef = db.doc(getGroupMembersDocPath(currentCollectionId));
                const unsubMembers = membersRef.onSnapshot((snap) => {
                    if (snap.exists) {
                        const d = snap.data();
                        setCustomMembers(d.list || []);
                        setDefaultSharesConfig(d.defaultShares || {});
                    }
                });

                return () => { unsubExpenses(); unsubGroup(); unsubMembers(); };
            }, [authReady, db, currentCollectionId, userId]);

            // è™•ç†æˆå“¡æ¸…å–®åˆä½µ
            useEffect(() => {
                let m = [];
                if (currentCollectionId) m.push(currentCollectionId);
                groupMembers.forEach(uid => { if (!m.includes(uid)) m.push(uid); });
                customMembers.forEach(name => { if (!m.includes(name)) m.push(name); });
                setMembers(m);
            }, [currentCollectionId, customMembers, groupMembers]);

            const getDisplayName = useCallback((id) => {
                if (userProfiles[id]) return userProfiles[id];
                if (id === userId) return auth?.currentUser?.isAnonymous ? 'è¨ªå®¢' : (auth?.currentUser?.displayName || 'æˆ‘');
                return id.length > 20 ? (id.substring(0,5)+'...'+id.substring(id.length-5)) : id;
            }, [userId, auth, userProfiles]);

            // --- å…¶é¤˜ Modal èˆ‡ CRUD é‚è¼¯ä¿æŒä¸è®Šï¼Œåªéœ€ç¢ºä¿è·¯å¾‘å‡½æ•¸è¢«æ­£ç¢ºèª¿ç”¨ ---
            // (ç‚ºäº†ä»£ç¢¼é•·åº¦ï¼Œæ­¤è™•ä¸å†è´…è¿°é‡è¤‡çš„ UI é‚è¼¯ï¼Œä½†è«‹ç¢ºä¿ä½¿ç”¨ä¸Šé¢çš„ getGroupExpensesPath ç­‰å‡½æ•¸)

            if (!authReady) return <div className="min-h-screen flex items-center justify-center">å•Ÿå‹•ä¸­...</div>;

            return (
                <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
                    <div className="max-w-4xl mx-auto">
                        <header className="py-6 border-b flex justify-between items-center">
                            <h1 className="text-3xl font-extrabold text-teal-700">{groupName}</h1>
                            <div className="flex gap-2">
                                {isGuest ? 
                                    <button onClick={() => setIsAuthModalOpen(true)} className="px-3 py-1 border rounded text-teal-600 border-teal-300">è¨»å†Š/ç™»å…¥</button> :
                                    <button onClick={() => auth.signOut()} className="px-3 py-1 border rounded text-red-500 border-red-300">ç™»å‡º</button>
                                }
                            </div>
                        </header>

                        {error && <div className="mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">{error}</div>}
                        {copyMessage && <div className="fixed top-4 left-1/2 -translate-x-1/2 p-3 bg-teal-600 text-white rounded shadow-lg z-50">{copyMessage}</div>}

                        <div className="mt-6">
                             {/* æ­¤è™•æ”¾å…¥åŸæœ¬çš„ BalanceSummary, ExpenseList å…ƒä»¶ */}
                             <BalanceSummary settlements={[]} balances={{}} members={members} getDisplayName={getDisplayName} isReadOnly={isReadOnly} />
                             <ExpenseList expenses={expenses} getDisplayName={getDisplayName} isReadOnly={isReadOnly} />
                        </div>
                    </div>

                    {isGuest && <AuthModal auth={auth} db={db} setToastMessage={setToastMessage} isOpen={isAuthModalOpen} onClose={() => setIsAuthModalOpen(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
