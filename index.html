<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180.png"> 
    <link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon--192.png"> 
    <link rel="apple-touch-icon" sizes="512x512" href="/apple-touch-icon--512.png">
	<title>åˆ†å¸³è¨˜å¸³ç°¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* ä¿®æ­£ï¼šç§»é™¤è¼¸å…¥æ¡†åŸç”Ÿçš„å¢æ¸›æ§åˆ¶é … */
        input[type='number'] {
            -moz-appearance: textfield;
        }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* âœ¨ NEW: ä¿®æ­£ Modal é–ƒçˆå•é¡Œï¼Œé‡å° Safari/WebKit å„ªåŒ– */
        .force-gpu {
            /* è®“ç€è¦½å™¨æ¨åˆ°ç¨ç«‹åœ–å±¤ï¼Œè§£æ±ºèƒŒæ™¯é–ƒçˆ */
            transform: translateZ(0);
            /* å‘Šè¨´ç€è¦½å™¨æº–å‚™è®ŠåŒ–ï¼Œé¿å…é‡æ–°è¨ˆç®— */
            will-change: transform; 
        }
    </style>
    
    <script>
        // è¨­å®š Tailwind CSS é¡è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primaryColor: {
                            500: '#14b8a6', // teal-500
                            600: '#0d9488', // teal-600
                            700: '#0f766e', // teal-700
                        },
                    },
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script>
        // ä¿®æ­£ï¼šå°‡é€™äº›è®Šæ•¸å®šç¾©åœ¨ç´” JS å€å¡Šï¼Œä½¿ Babel è…³æœ¬å¯ä»¥è¨ªå•
        const __app_id = "YOUR_APP_ID"; // ä¾‹å¦‚: 'my-splitwise-app-2025'
        // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½® JSON
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyANDhJ--MDYI5SfsHOuuQwVM0sYMM91UFM",
            authDomain: "splite-expense-tracker-multi.firebaseapp.com",
            projectId: "splite-expense-tracker-multi",
            storageBucket: "splite-expense-tracker-multi.firebasestorage.app",
            messagingSenderId: "10696910340",
            appId: "1:425612895494:web:b5889f1d83cafb41d7ea87",
            measurementId: "G-XCB90NSB43"
        });
        // åŒ¿åç™»å…¥ä¸å†ä½¿ç”¨ï¼Œæ•…ä¸éœ€è¦ __initial_auth_token

        // æ–°å¢ï¼šè«‹å°‡æ‚¨çš„ Gemini API Key å¡«å…¥æ­¤è™•ï¼ˆç›®å‰æœªä½¿ç”¨ï¼‰
        const GEMINI_API_KEY = ""; 
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    
    <script type="text/babel">
        const React = window.React;
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // --- æ ¸å¿ƒè¨­å®šï¼šç›´æ¥é–å®šæˆªåœ–ä¸­çš„è·¯å¾‘ ---
        const appId = "YOUR_APP_ID"; 
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        const { firestore } = firebase;
        const serverTimestamp = firestore.FieldValue.serverTimestamp; 
        
        const getGroupExpensesPath = (groupId) => `artifacts/${appId}/groups/${groupId}/expenses`;
        const getGroupMembersDocPath = (groupId) => `artifacts/${appId}/groups/${groupId}/settings/members`;
        const getGroupDocPath = (groupId) => `artifacts/${appId}/groups/${groupId}`;

        // --- åŒ¯ç‡èˆ‡å¸¸æ•¸ ---
        const PERMANENT_RATES_CACHE_KEY = "permanentExchangeRates";
        const HARDCODED_DEFAULT_RATES = { 'TWD': 1.0, 'CNY': 4.5, 'USD': 30.5, 'THB': 0.85, 'EUR': 33.0, 'CAD': 22.5, 'VND': 0.0013, 'IDR': 0.002, 'JPY': 0.25, 'KRW': 0.023, 'AUD': 20.0, 'NOK': 2.9 };
        let DEFAULT_EXCHANGE_RATES = HARDCODED_DEFAULT_RATES;
        const CURRENCIES = Object.keys(HARDCODED_DEFAULT_RATES);
        const DEFAULT_CURRENCY = 'TWD';

        // --- å·¥å…·å‡½æ•¸ ---
        const generateShortCode = (length = 6) => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let res = '';
            for (let i = 0; i < length; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
            return res;
        };

        const fetchExchangeRates = async () => {
            try {
                const res = await fetch("https://open.er-api.com/v6/latest/TWD");
                const data = await res.json();
                if (data.result === "success") {
                    const rates = { [DEFAULT_CURRENCY]: 1.0 };
                    CURRENCIES.forEach(c => { if(c!==DEFAULT_CURRENCY) rates[c] = 1 / data.rates[c]; });
                    return { rates, lastUpdate: Date.now() };
                }
            } catch (e) { console.error("Rate fetch failed"); }
            return { rates: DEFAULT_EXCHANGE_RATES, lastUpdate: Date.now() };
        };

        // --- åœ–æ¨™å…ƒä»¶ ---
        const IconProps = { stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", fill: "none" };
        const CircleDollarSign = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>;
        const Trash2 = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>;
        const Plus = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>;
        const Minus = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M5 12h14"/></svg>;
        const Users = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const X = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>;
        const CircleCheck = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14 9 11"/></svg>;
        const Pencil = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const LogOut = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
        const Share2 = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.42" x2="8.59" y1="6.51" y2="10.49"/></svg>;
        const Search = (p) => <svg {...p} {...IconProps} viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>;

        // --- å…±ç”¨çµ„ä»¶ ---
        const ConfirmationModal = React.memo(({ isOpen, onClose, onConfirm, title, message, confirmText, confirmColor = 'red' }) => {
            if (!isOpen) return null;
            const colorClass = confirmColor === 'green' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700';
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[9999] force-gpu">
                    <div className="bg-white rounded-xl w-full max-w-sm shadow-2xl p-6 force-gpu">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">{title}</h3>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex justify-end space-x-3">
                            <button onClick={onClose} className="px-4 py-2 rounded-full text-gray-700 bg-gray-200 font-semibold">å–æ¶ˆ</button>
                            <button onClick={onConfirm} className={`px-4 py-2 rounded-full text-white font-semibold shadow-md ${colorClass}`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        });

        // --- æ ¸å¿ƒé‚è¼¯çµ„ä»¶ï¼šBalanceSummary ---
        const BalanceSummary = React.memo(({ settlements, balances, members, getDisplayName, isReadOnly, settleMemberDebt }) => {
            return (
                <div className="mt-8 p-6 bg-white rounded-xl shadow-lg">
                    <h2 className="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                        <Users className="w-7 h-7 mr-3 text-teal-500" /> çµé¤˜ç¸½çµ
                    </h2>
                    {settlements.length === 0 ? (
                        <p className="text-lg font-medium text-green-600 p-3 bg-green-50 rounded-lg">ğŸ‰ æ‰€æœ‰å¸³ç›®å·²çµæ¸…ï¼</p>
                    ) : (
                        <div className="space-y-4">
                            {settlements.map((s, i) => (
                                <div key={i} className="bg-yellow-50 p-4 rounded-xl border-l-4 border-yellow-400 flex justify-between items-center">
                                    <div>
                                        <p className="text-lg">
                                            <span className="font-bold text-red-600">{getDisplayName(s.from)}</span>
                                            <span className="mx-2 text-gray-500">æ‡‰ä»˜çµ¦</span>
                                            <span className="font-bold text-green-600">{getDisplayName(s.to)}</span>
                                        </p>
                                        <p className="text-2xl font-extrabold text-yellow-700 mt-1">TWD {Math.round(s.amount)}</p>
                                    </div>
                                    {!isReadOnly && (
                                        <button onClick={() => settleMemberDebt(s.from, s.amount, s.to)} className="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-bold shadow-md">çµæ¸…</button>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        });

        // --- æ ¸å¿ƒé‚è¼¯çµ„ä»¶ï¼šExpenseList ---
        const ExpenseList = React.memo(({ expenses, deleteExpense, startEdit, isLoading, getDisplayName, searchKeyword, setSearchKeyword, isReadOnly, clearAllExpenses }) => {
            const filtered = useMemo(() => {
                let res = [...expenses].sort((a,b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
                if (searchKeyword.trim()) res = res.filter(e => (e.description||'').toLowerCase().includes(searchKeyword.toLowerCase()));
                return res;
            }, [expenses, searchKeyword]);

            return (
                <div className="mt-8">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-800">æ‰€æœ‰æ”¯å‡º ({expenses.length})</h2>
                        {!isReadOnly && (
                            <button onClick={clearAllExpenses} className="px-3 py-1 bg-red-500 text-white rounded text-xs">æ¸…é™¤æ‰€æœ‰</button>
                        )}
                    </div>
                    <div className="relative mb-4">
                        <input type="text" value={searchKeyword} onChange={e => setSearchKeyword(e.target.value)} placeholder="æœå°‹å“é …..." className="w-full pl-10 pr-4 py-2 border rounded-full text-sm focus:ring-teal-500" />
                        <Search className="w-5 h-5 absolute left-3 top-2.5 text-gray-400" />
                    </div>
                    <div className="space-y-4">
                        {filtered.map(exp => (
                            <div key={exp.id} className="bg-white p-4 rounded-xl shadow border-l-4 border-teal-400 flex justify-between items-center">
                                <div>
                                    <p className="font-bold text-gray-800">{exp.description}</p>
                                    <p className="text-2xl font-black text-teal-600">{exp.currency} {Math.round(exp.originalAmount)} <span className="text-sm font-normal text-gray-400">â‰ˆ TWD {Math.round(exp.amountInTWD)}</span></p>
                                    <p className="text-xs text-gray-500">ä»˜æ¬¾äºº: {getDisplayName(exp.payerName)}</p>
                                </div>
                                <div className="flex gap-2">
                                    {!isReadOnly && (
                                        <>
                                            <button onClick={() => startEdit(exp)} className="p-2 text-blue-500 bg-blue-50 rounded-full"><Pencil className="w-4 h-4"/></button>
                                            <button onClick={() => deleteExpense(exp.id)} className="p-2 text-red-500 bg-red-50 rounded-full"><Trash2 className="w-4 h-4"/></button>
                                        </>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        });

        // --- ä¸»ç¨‹å¼ App ---
        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [authReady, setAuthReady] = useState(false);
            const [isGuest, setIsGuest] = useState(false);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            const [userProfiles, setUserProfiles] = useState({});
            const [liveExchangeRates, setLiveExchangeRates] = useState(DEFAULT_EXCHANGE_RATES);
            const [currentCollectionId, setCurrentCollectionId] = useState(null);
            const [groupMembers, setGroupMembers] = useState([]);
            const [groupName, setGroupName] = useState('åˆ†å¸³è¨˜å¸³ç°¿');
            const [expenses, setExpenses] = useState([]);
            const [customMembers, setCustomMembers] = useState([]);
            const [defaultSharesConfig, setDefaultSharesConfig] = useState({});
            const [members, setMembers] = useState([]);
            const [error, setError] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [searchKeyword, setSearchKeyword] = useState('');
            const [copyMessage, setCopyMessage] = useState('');
            const [confirmModalState, setConfirmModalState] = useState({ isOpen: false });

            const isReadOnly = isGuest || (userId && groupMembers.length > 0 && !groupMembers.includes(userId));

            const ensureDefaultGroup = useCallback(async (_db, uid) => {
                const groupRef = _db.doc(getGroupDocPath(uid));
                const snap = await groupRef.get();
                if (!snap.exists) {
                    await groupRef.set({ owner: uid, members: [uid], createdAt: serverTimestamp(), name: 'æˆ‘çš„åˆ†å¸³è¨˜å¸³ç°¿' });
                }
            }, []);

            // --- èªè­‰åˆå§‹åŒ–ï¼šå…ˆå»ºç«‹è³‡æ–™å¤¾å†å•Ÿå‹• ---
            useEffect(() => {
                if (!firebaseConfig) return;
                const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
                const _auth = app.auth(); const _db = app.firestore();
                setDb(_db); setAuth(_auth);

                const unsub = _auth.onAuthStateChanged(async (user) => {
                    try {
                        if (user) {
                            setUserId(user.uid);
                            setIsGuest(user.isAnonymous);
                            if (!user.isAnonymous) await ensureDefaultGroup(_db, user.uid);
                            
                            // è§£æ URL çŸ­ä»£ç¢¼ (ç•¥ï¼Œé è¨­å›è‡ªå·±çš„ ID)
                            let targetId = user.uid;
                            const path = window.location.pathname;
                            if (path.includes('/g/')) {
                                const code = path.split('/g/')[1].split('/')[0];
                                const snap = await _db.collection(`artifacts/${appId}/users`).where('shortCode', '==', code).limit(1).get();
                                if(!snap.empty) targetId = snap.docs[0].id;
                            }
                            setCurrentCollectionId(targetId);
                        } else {
                            await _auth.signInAnonymously();
                        }
                    } catch (e) { console.error(e); }
                    finally { setAuthReady(true); }
                });
                return () => unsub();
            }, [ensureDefaultGroup]);

            // --- è³‡æ–™ç›£è½ ---
            useEffect(() => {
                if (!authReady || !db || !currentCollectionId) return;
                const unsubExpenses = db.collection(getGroupExpensesPath(currentCollectionId)).onSnapshot(s => {
                    setExpenses(s.docs.map(d => ({ id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate() })));
                    setError(null);
                }, err => { if(err.code === 'permission-denied' && currentCollectionId !== userId) setError("æ¬Šé™ä¸è¶³ï¼šç„¡æ³•è®€å–æ­¤ç´€éŒ„ç°¿"); });
                
                const unsubGroup = db.doc(getGroupDocPath(currentCollectionId)).onSnapshot(s => {
                    if(s.exists) { setGroupName(s.data().name || 'åˆ†å¸³è¨˜å¸³ç°¿'); setGroupMembers(s.data().members || []); }
                });

                const unsubMembers = db.doc(getGroupMembersDocPath(currentCollectionId)).onSnapshot(s => {
                    if(s.exists) { setCustomMembers(s.data().list || []); setDefaultSharesConfig(s.data().defaultShares || {}); }
                });

                return () => { unsubExpenses(); unsubGroup(); unsubMembers(); };
            }, [authReady, db, currentCollectionId, userId]);

            // --- æˆå“¡åˆä½µ ---
            useEffect(() => {
                let m = []; if(currentCollectionId) m.push(currentCollectionId);
                groupMembers.forEach(uid => { if(!m.includes(uid)) m.push(uid); });
                customMembers.forEach(name => { if(!m.includes(name)) m.push(name); });
                setMembers(m);
            }, [currentCollectionId, groupMembers, customMembers]);

            // --- é‹ç®—é‚è¼¯ ---
            const calculateBalances = useMemo(() => {
                const bals = {}; members.forEach(m => bals[m] = 0);
                expenses.forEach(e => {
                    const amt = e.amountInTWD; const payer = e.payerName;
                    const totalS = Object.values(e.shares || {}).reduce((a,b)=>a+b, 0);
                    if(totalS === 0) return;
                    if(bals[payer] !== undefined) bals[payer] += amt;
                    Object.entries(e.shares || {}).forEach(([m, s]) => { if(bals[m] !== undefined) bals[m] -= (amt/totalS)*s; });
                });
                return bals;
            }, [expenses, members]);

            const settlements = useMemo(() => {
                const sets = []; const b = {...calculateBalances};
                const creditors = [], debtors = [];
                Object.entries(b).forEach(([m, bal]) => { if(bal >= 1) creditors.push({m, bal}); else if(bal <= -1) debtors.push({m, bal: -bal}); });
                let i=0, j=0;
                while(i < debtors.length && j < creditors.length) {
                    const d = debtors[i], c = creditors[j];
                    const amt = Math.min(d.bal, c.bal);
                    if(amt > 0) sets.push({from: d.m, to: c.m, amount: amt});
                    d.bal -= amt; c.bal -= amt;
                    if(d.bal < 1) i++; if(c.bal < 1) j++;
                }
                return sets;
            }, [calculateBalances]);

            const getDisplayName = useCallback((id) => {
                if (userProfiles[id]) return userProfiles[id];
                if (id === userId) return isGuest ? 'è¨ªå®¢' : (auth?.currentUser?.displayName || 'æˆ‘');
                return id.length > 20 ? (id.substring(0,5)+'...'+id.substring(id.length-5)) : id;
            }, [userId, isGuest, userProfiles, auth]);

            if (!authReady) return <div className="min-h-screen flex items-center justify-center text-teal-600">å•Ÿå‹•ä¸­...</div>;

            return (
                <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
                    <div className="max-w-4xl mx-auto">
                        <header className="py-6 border-b flex justify-between items-center">
                            <h1 className="text-3xl font-extrabold text-teal-700">{groupName}</h1>
                            <div>
                                {isGuest ? 
                                    <button onClick={() => setIsAuthModalOpen(true)} className="px-3 py-1.5 border border-teal-500 text-teal-600 rounded-lg font-bold">ç™»å…¥</button> :
                                    <button onClick={() => auth.signOut()} className="px-3 py-1.5 border border-red-300 text-red-500 rounded-lg font-bold">ç™»å‡º</button>
                                }
                            </div>
                        </header>
                        {error && <div className="mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">{error}</div>}
                        <BalanceSummary settlements={settlements} balances={calculateBalances} members={members} getDisplayName={getDisplayName} isReadOnly={isReadOnly} settleMemberDebt={()=>{}} />
                        <ExpenseList expenses={expenses} getDisplayName={getDisplayName} isReadOnly={isReadOnly} searchKeyword={searchKeyword} setSearchKeyword={setSearchKeyword} deleteExpense={()=>{}} startEdit={()=>{}} clearAllExpenses={()=>{}} />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
