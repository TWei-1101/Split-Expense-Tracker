<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å¸³è¨˜å¸³ç°¿</title>
    <!-- å¼•å…¥ Tailwind CSS CDN ä»¥ç¢ºä¿æ¨£å¼åœ¨æ‰€æœ‰ç’°å¢ƒä¸‹éƒ½èƒ½é‹ä½œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React, ReactDOM, and Babel ç¨ç«‹ç‰ˆ -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        // è¨­å®š Tailwind CSS é¡è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primaryColor: {
                            500: '#14b8a6', // teal-500
                            600: '#0d9488', // teal-600
                            700: '#0f766e', // teal-700
                        },
                    },
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- 
        é‡è¦ï¼šè«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ Firebase é…ç½®ï¼
        ç”±æ–¼é€™æ˜¯ç¨ç«‹çš„ HTML æª”æ¡ˆï¼Œæ‚¨éœ€è¦æ‰‹å‹•æä¾›é€™äº›è®Šæ•¸ï¼Œå¦å‰‡ App ç„¡æ³•é€£æ¥åˆ°æ‚¨çš„è³‡æ–™åº«ã€‚
        è«‹å°‡ YOUR_APP_ID å’Œ { YOUR_FIREBASE_CONFIG_JSON } æ›¿æ›ç‚ºå¯¦éš›å€¼ã€‚
    -->
    <script>
        const __app_id = "YOUR_APP_ID"; // ä¾‹å¦‚: 'my-splitwise-app-2025'
        // è«‹æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½® JSON
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyB8l7Od781kGHyI9pXMLBXvzt7NuuIyq8c",
            authDomain: "splite-expense-tracker.firebaseapp.com",
            projectId: "splite-expense-tracker",
            storageBucket: "splite-expense-tracker.firebasestorage.app",
            messagingSenderId: "425612895494",
            appId: "1:425612895494:web:b5889f1d83cafb41d7ea87",
            measurementId: "G-FVS0WSGZD9"
        });
        const __initial_auth_token = null; // ä¿æŒ null é€²è¡ŒåŒ¿åç™»å…¥
    </script>

    <script type="text/babel">
        // åœ¨é€™è£¡ä½¿ç”¨ React ç¨‹å¼ç¢¼
        const { useState, useEffect, useCallback, useMemo } = React;
        const { initializeApp } = firebase;
        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = firebase.auth;
        const { 
            getFirestore, collection, query, onSnapshot, addDoc, doc, deleteDoc, updateDoc, setDoc,
            serverTimestamp, setLogLevel
        } = firebase.firestore;
        
        // --- é‡æ–°å®šç¾© Firebase å…¨åŸŸè®Šæ•¸ä»¥ä¾› React å­˜å– ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // è¨­ç½® Firebase æ—¥èªŒç´šåˆ¥
        // ä¿®æ­£: é¿å…åœ¨ç€è¦½å™¨ç’°å¢ƒä¸­ç›´æ¥å­˜å– process.env å°è‡´ ReferenceError
        if (typeof process !== 'undefined' && process.env.NODE_ENV !== 'production') {
          setLogLevel('debug');
        }

        // é¡è‰²å®šç¾©
        const primaryColor = 'teal';

        const { CircleDollarSign, Trash2, Plus, Minus, Users, X, Check, Pencil, UserPlus, UserMinus } = lucide;

        /**
         * ä¸»è¦çš„ App å…ƒä»¶
         * @returns {JSX.Element}
         */
        const App = () => {
          // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [userId, setUserId] = useState(null);
          const [authReady, setAuthReady] = useState(false);
          const [expenses, setExpenses] = useState([]);
          
          // æˆå“¡ç®¡ç†ç‹€æ…‹
          const [customMembers, setCustomMembers] = useState([]); // å„²å­˜ä½¿ç”¨è€…æ‰‹å‹•æ–°å¢çš„æˆå“¡åç¨± (ä¸åŒ…å« userId)
          const [defaultSharesConfig, setDefaultSharesConfig] = useState({}); // å„²å­˜æ¯å€‹æˆå“¡çš„é è¨­ä»½æ•¸ { name: shareCount } (éé è¨­å€¼ 1)
          const [members, setMembers] = useState([]); // å„²å­˜æ‰€æœ‰åƒèˆ‡åˆ†å¸³çš„æˆå“¡åç¨± (åŒ…å« userId)
          
          // Modal ç‹€æ…‹
          const [isMemberModalOpen, setIsMemberModalOpen] = useState(false);
          const [newMemberName, setNewMemberName] = useState('');
          const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);
          const [editingExpenseId, setEditingExpenseId] = useState(null); 
          
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState(null);

          // æ–°å¢æ”¯å‡º/ç·¨è¼¯è¡¨å–®ç‹€æ…‹ (ç”¨æ–¼æš«å­˜ Modal å…§éƒ¨çš„è³‡æ–™)
          const [newExpense, setNewExpense] = useState({
            description: '',
            amount: '',
            payerName: '',
            shares: {}, // ç´€éŒ„åˆ†å¸³ä»½æ•¸
          });

          // --- 1. Firebase åˆå§‹åŒ–èˆ‡é©—è­‰ ---
          useEffect(() => {
            if (!firebaseConfig) {
              setError('Firebase configuration is missing.');
              return;
            }

            try {
              const app = initializeApp(firebaseConfig);
              const _auth = getAuth(app);
              const _db = getFirestore(app);

              setDb(_db);
              setAuth(_auth);

              const unsubscribe = onAuthStateChanged(_auth, async (user) => {
                if (user) {
                  setUserId(user.uid);
                  setNewExpense(prev => ({
                    ...prev,
                    payerName: user.uid, 
                  }));
                }
                setAuthReady(true);
              });

              if (initialAuthToken) {
                signInWithCustomToken(_auth, initialAuthToken)
                  .catch(err => {
                    console.error('Custom token sign-in failed, falling back to anonymous:', err);
                    signInAnonymously(_auth).catch(e => setError(`Auth error: ${e.message}`));
                  });
              } else {
                signInAnonymously(_auth)
                  .catch(e => setError(`Auth error: ${e.message}`));
              }

              return () => unsubscribe();
            } catch (e) {
              setError(`Firebase initialization failed: ${e.message}`);
            }
          }, []);

          // --- 2. æ•¸æ“šç²å– (Firestore ç›£è½) ---
          useEffect(() => {
            // é—œéµä¿®å¾©: åªæœ‰ç•¶ DB åˆå§‹åŒ–å®Œæˆ AND æˆåŠŸå–å¾— userId (å³é€šéèº«ä»½é©—è­‰) æ™‚æ‰ç›£è½è³‡æ–™
            if (!authReady || !db || !userId) return; 

            // --- A. ç›£è½æ”¯å‡ºè¨˜éŒ„ ---
            const expensesCollectionPath = `artifacts/${appId}/public/data/expenses`;
            const expensesRef = collection(db, expensesCollectionPath);
            const expensesQuery = query(expensesRef);

            const unsubscribeExpenses = onSnapshot(expensesQuery, (snapshot) => {
              const fetchedExpenses = snapshot.docs.map(doc => {
                const data = doc.data();
                // è™•ç† Firestore Timestamp è½‰æ›ç‚º JavaScript Date ç‰©ä»¶
                const timestamp = data.timestamp ? data.timestamp.toDate() : null; 
                
                return {
                  id: doc.id,
                  ...data,
                  amount: typeof data.amount === 'number' ? data.amount : parseFloat(data.amount || 0),
                  shares: data.shares || {},
                  timestamp: timestamp,
                };
              });
              setExpenses(fetchedExpenses);
            }, (err) => {
              console.error("Error listening to expenses:", err);
              setError(`è³‡æ–™åŒæ­¥å¤±æ•—: ${err.message}`);
            });

            // --- B. ç›£è½æˆå“¡è¨­å®š ---
            const membersDocPath = `artifacts/${appId}/public/data/settings/members`;
            const membersDocRef = doc(db, membersDocPath);

            const unsubscribeMembers = onSnapshot(membersDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const list = Array.isArray(data.list) ? data.list : [];
                    const shares = data.defaultShares || {};
                    
                    setCustomMembers(list);
                    setDefaultSharesConfig(shares); // å„²å­˜æ‰€æœ‰éé è¨­å€¼ 1 çš„ä»½æ•¸è¨­å®š
                } else {
                    setCustomMembers([]);
                    setDefaultSharesConfig({}); 
                }
            }, (err) => {
                console.error("Error listening to members settings:", err);
            });

            return () => {
              unsubscribeExpenses();
              unsubscribeMembers();
            };
          }, [authReady, db, userId]);

          // --- 3. è¡ç”Ÿç‹€æ…‹ï¼šè¨ˆç®—æœ€çµ‚æˆå“¡æ¸…å–® ---
          useEffect(() => {
            // ç¸½æˆå“¡æ¸…å–®ï¼šåŒ…å«ç•¶å‰ç”¨æˆ¶ ID å’Œè‡ªè¨‚æˆå“¡
            let currentMembers = [userId].filter(Boolean); 
            
            // éæ¿¾æ‰èˆ‡ userId é‡è¤‡çš„è‡ªè¨‚æˆå“¡ï¼Œä¸¦åŠ å…¥æ¸…å–®
            customMembers.forEach(name => {
                if (name !== userId && !currentMembers.includes(name)) {
                    currentMembers.push(name);
                }
            });

            // å°‡æ‰€æœ‰æˆå“¡æŒ‰å­—æ¯é †åºæ’åº
            setMembers(currentMembers.sort());

          }, [userId, customMembers]);

          /**
           * æ ¹æ“šç•¶å‰çš„æˆå“¡æ¸…å–®å’Œé è¨­ä»½æ•¸é…ç½®ï¼Œç”¢ç”Ÿåˆå§‹çš„åˆ†å¸³ä»½æ•¸ç‰©ä»¶
           */
          const getInitialShares = useCallback(() => {
            return members.reduce((acc, name) => {
                // ä½¿ç”¨ defaultSharesConfig ä¸­çš„è¨­å®šå€¼ï¼Œè‹¥ç„¡å‰‡é è¨­ç‚º 1 (å¹³å‡åˆ†é…)
                const shareValue = defaultSharesConfig[name] !== undefined ? defaultSharesConfig[name] : 1;
                acc[name] = shareValue;
                return acc;
            }, {});
          }, [members, defaultSharesConfig]);

          // ç•¶æˆå“¡æ¸…å–®æ›´æ–°æ™‚ï¼Œå¦‚æœ Modal é—œé–‰ï¼Œé‡è¨­æ–°å¢è¡¨å–®çš„åˆ†å¸³ä»½æ•¸
          useEffect(() => {
            if (!isExpenseModalOpen && userId) {
                setNewExpense(prev => ({
                    ...prev,
                    payerName: prev.payerName || userId,
                    shares: getInitialShares(), // ä½¿ç”¨é è¨­ä»½æ•¸åˆå§‹åŒ–
                }));
            }
          }, [members, isExpenseModalOpen, userId, getInitialShares]);


          // --- Modal é–‹å•Ÿ/é—œé–‰å’Œæ¨¡å¼æ§åˆ¶ ---

          const closeExpenseModal = () => {
            setIsExpenseModalOpen(false);
            setEditingExpenseId(null);
            // é‡è¨­è¡¨å–®ç‹€æ…‹ç‚ºé è¨­ã€Œæ–°å¢ã€ç‹€æ…‹ (ä½¿ç”¨é è¨­ä»½æ•¸)
            setNewExpense({
              description: '',
              amount: '',
              payerName: userId, 
              shares: getInitialShares(),
            });
          };

          const startAdd = () => {
            setEditingExpenseId(null);
            // ç¢ºä¿è¡¨å–®ç‹€æ…‹ç‚ºæ–°çš„ï¼Œä¸¦æ ¹æ“šç•¶å‰ members åˆ—è¡¨åˆå§‹åŒ– shares
            setNewExpense({
              description: '',
              amount: '',
              payerName: userId,
              shares: getInitialShares(), // ä½¿ç”¨é è¨­ä»½æ•¸åˆå§‹åŒ–
            });
            setIsExpenseModalOpen(true);
          };
          
          const startEdit = (expense) => {
            setEditingExpenseId(expense.id);
            
            // è¼‰å…¥ç¾æœ‰æ”¯å‡ºè³‡æ–™åˆ°è¡¨å–®ç‹€æ…‹
            const initialShares = members.reduce((acc, name) => ({ 
              ...acc, 
              [name]: expense.shares[name] !== undefined ? expense.shares[name] : 0 
            }), {});
            
            setNewExpense({
              description: expense.description,
              amount: expense.amount,
              payerName: expense.payerName,
              shares: initialShares,
            });
            setIsExpenseModalOpen(true);
          };


          // --- 4. æ”¯å‡º CRUD æ“ä½œ ---

          /**
           * è™•ç†è¡¨å–®è¼¸å…¥è®ŠåŒ–
           */
          const handleInputChange = (e) => {
            const { name, value } = e.target;
            setNewExpense(prev => ({
              ...prev,
              [name]: name === 'amount' ? parseFloat(value) || '' : value,
            }));
          };

          /**
           * è™•ç†ä»½æ•¸è®ŠåŒ–
           */
          const handleShareChange = (name, delta) => {
            setNewExpense(prev => {
              const currentShares = prev.shares[name] || 0;
              const newShares = Math.max(0, currentShares + delta);
              return {
                ...prev,
                shares: {
                  ...prev.shares,
                  [name]: newShares,
                },
              };
            });
          };

          /**
           * è¨­å®šç‚ºå¹³å‡åˆ†é…ï¼ˆæ¯äºº 1 ä»½ï¼‰
           */
          const setToAverageSplit = () => {
            const averageShares = members.reduce((acc, name) => ({ ...acc, [name]: 1 }), {});
            setNewExpense(prev => ({
              ...prev,
              shares: averageShares,
            }));
          };
          
          /**
           * å„²å­˜ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¼‰æ”¯å‡ºè¨˜éŒ„
           */
          const saveExpense = async () => {
            if (!db || !userId) return;
            const isEditing = !!editingExpenseId;

            if (!newExpense.description || newExpense.amount <= 0 || !newExpense.payerName) {
              console.error('è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …ã€é‡‘é¡å’Œä»˜æ¬¾äººï¼');
              return;
            }

            setIsLoading(true);
            setError(null);
            try {
              const expenseToSave = {
                description: newExpense.description,
                amount: newExpense.amount,
                payerName: newExpense.payerName,
                shares: Object.entries(newExpense.shares).reduce((acc, [name, share]) => {
                  if (share > 0) acc[name] = share;
                  return acc;
                }, {}),
                // æ–°å¢/æ›´æ–°æ™‚ï¼Œåªæœ‰æ–°å¢æ™‚æ‰è¨­å®š timestamp
                ...(isEditing ? {} : { timestamp: serverTimestamp() }), 
                appId: appId,
              };

              const collectionPath = `artifacts/${appId}/public/data/expenses`;

              if (isEditing) {
                const docPath = `${collectionPath}/${editingExpenseId}`;
                // ç·¨è¼¯æ™‚ä¸æ›´æ–° timestamp
                await updateDoc(doc(db, docPath), expenseToSave); 
              } else {
                await addDoc(collection(db, collectionPath), expenseToSave);
              }

              closeExpenseModal();
            } catch (e) {
              console.error("Error saving document: ", e);
              setError(`å„²å­˜æ”¯å‡ºå¤±æ•—: ${e.message}`);
            } finally {
              setIsLoading(false);
            }
          };

          /**
           * åˆªé™¤æ”¯å‡ºè¨˜éŒ„
           */
          const deleteExpense = async (id) => {
            if (!db) return;
            console.warn('âš ï¸ åˆªé™¤æ“ä½œè¢«åŸ·è¡Œã€‚åœ¨å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰ä½¿ç”¨è‡ªå®šç¾©ç¢ºèªè¦–çª—ã€‚');

            setIsLoading(true);
            setError(null);
            try {
              const docPath = `artifacts/${appId}/public/data/expenses/${id}`;
              await deleteDoc(doc(db, docPath));
            } catch (e) {
              console.error("Error deleting document: ", e);
              setError(`åˆªé™¤æ”¯å‡ºå¤±æ•—: ${e.message}`);
            } finally {
              setIsLoading(false);
            }
          };

          // --- 5. æˆå“¡ç®¡ç†é‚è¼¯ ---
          
          /**
           * å„²å­˜æˆå“¡æ¸…å–®å’Œç•¶å‰çš„é è¨­ä»½æ•¸è¨­å®š
           */
          const saveMembers = async (newMemberList) => {
            if (!db) return;

            setIsLoading(true);
            setError(null);
            try {
                const docPath = `artifacts/${appId}/public/data/settings/members`;
                const membersDocRef = doc(db, docPath);

                // éæ¿¾æ‰ç©ºç™½åç¨±ã€èˆ‡ userId ç›¸åŒçš„åç¨±ï¼Œä¸¦ç¢ºä¿åç¨±å”¯ä¸€
                const sanitizedList = Array.from(new Set(
                    newMemberList.filter(name => name.trim() !== '' && name !== userId)
                ));

                // æ•´ç†è¦å„²å­˜çš„ shares config (åªå„²å­˜éé è¨­å€¼ 1 çš„ä»½æ•¸)
                const currentShares = {};
                members.forEach(name => {
                    const share = defaultSharesConfig[name] !== undefined ? defaultSharesConfig[name] : 1;
                    if (share !== 1 && share >= 0) {
                        currentShares[name] = share;
                    }
                });

                await setDoc(membersDocRef, { list: sanitizedList, defaultShares: currentShares }, { merge: false });
            } catch (e) {
                console.error("Error saving members:", e);
                setError(`å„²å­˜æˆå“¡æ¸…å–®å¤±æ•—: ${e.message}`);
            } finally {
                setIsLoading(false);
            }
          };

          const handleAddMember = async () => {
            const trimmedName = newMemberName.trim();
            if (trimmedName && trimmedName !== userId && !customMembers.includes(trimmedName)) {
                const newMemberList = [...customMembers, trimmedName];
                await saveMembers(newMemberList); 
                setNewMemberName('');
            } else if (trimmedName === userId) {
                console.log("ä¸èƒ½å°‡è‡ªå·±çš„ç”¨æˆ¶ ID æ–°å¢ç‚ºæˆå“¡ã€‚");
            }
          };

          const handleDeleteMember = async (nameToDelete) => {
            const newMemberList = customMembers.filter(name => name !== nameToDelete);
            await saveMembers(newMemberList);
            
            // å¾é è¨­ä»½æ•¸é…ç½®ä¸­ç§»é™¤æ­¤æˆå“¡
            setDefaultSharesConfig(prev => {
                const newState = { ...prev };
                delete newState[nameToDelete];
                return newState;
            });
          };
          
          /**
           * å„²å­˜é è¨­ä»½æ•¸è¨­å®š
           */
          const handleSaveDefaultShares = async (tempShares) => {
            if (!db) return;

            setIsLoading(true);
            setError(null);
            try {
                const docPath = `artifacts/${appId}/public/data/settings/members`;
                const membersDocRef = doc(db, docPath);

                const sharesToSave = {};
                // æ•´ç†è¦å„²å­˜çš„ shares config (åªå„²å­˜éé è¨­å€¼ 1 çš„ä»½æ•¸)
                members.forEach(name => {
                    const share = tempShares[name];
                    if (share !== undefined && share >= 0) {
                        // åªæœ‰ç•¶ä»½æ•¸ä¸ç­‰æ–¼ 1 æ™‚æ‰å„²å­˜ï¼Œä»¥ä¿æŒè³‡æ–™åº«ä¹¾æ·¨
                        if (share !== 1) { 
                            sharesToSave[name] = share;
                        }
                    }
                });
                
                // ä¿å­˜æˆå“¡åˆ—è¡¨ (customMembers) å’Œæ–°çš„é è¨­ä»½æ•¸
                await setDoc(membersDocRef, { list: customMembers, defaultShares: sharesToSave }, { merge: false });
                
                setIsMemberModalOpen(false);
            } catch (e) {
                console.error("Error saving default shares:", e);
                setError(`å„²å­˜é è¨­ä»½æ•¸å¤±æ•—: ${e.message}`);
            } finally {
                setIsLoading(false);
            }
          };


          // --- 6. åˆ†å¸³è¨ˆç®—é‚è¼¯ ---

          /**
           * è¨ˆç®—æ¯å€‹æˆå“¡çš„æœ€çµ‚é¤˜é¡ï¼ˆæ‡‰ä»˜/æ‡‰æ”¶ï¼‰
           */
          const calculateBalances = useMemo(() => {
            const balances = members.reduce((acc, name) => ({ ...acc, [name]: 0 }), {});

            expenses.forEach(expense => {
              const { amount, payerName, shares } = expense;
              const totalShares = Object.values(shares).reduce((sum, s) => sum + s, 0);

              if (totalShares === 0) return;

              const costPerShare = amount / totalShares;

              if (balances[payerName] !== undefined) {
                balances[payerName] += amount;
              }

              Object.entries(shares).forEach(([member, shareCount]) => {
                const memberCost = costPerShare * shareCount;
                if (balances[member] !== undefined) {
                  balances[member] -= memberCost;
                }
              });
            });

            return balances;
          }, [expenses, members]);

          /**
           * è¨ˆç®—æ¸…ç®—æ–¹æ¡ˆï¼šæœ€å°‘æ¬¡æ•¸çš„è½‰å¸³ä¾†çµæ¸…æ‰€æœ‰å‚µå‹™
           */
          const calculateSettlements = useMemo(() => {
            const balances = calculateBalances;
            const settlements = [];

            const creditors = []; 
            const debtors = []; 

            const mutableBalances = { ...balances };

            // 1. åˆ†é›¢å‚µæ¬Šäºº (Creditors) å’Œå‚µå‹™äºº (Debtors)
            for (const member in mutableBalances) {
                const balance = mutableBalances[member];
                // å®¹å¿å°æ•¸é»èª¤å·® (e.g., $0.01)
                if (balance >= 1) { // è‡³å°‘æœ‰ 1 å…ƒä»¥ä¸Šçš„çµé¤˜
                    // å°æ–¼å‚µæ¬Šäººï¼Œæˆ‘å€‘åªé—œå¿ƒä»–å€‘æ‡‰æ”¶çš„é‡‘é¡
                    creditors.push({ name: member, amount: balance });
                } else if (balance <= -1) { // è‡³å°‘æ¬  1 å…ƒä»¥ä¸Šçš„å‚µå‹™
                    // å°æ–¼å‚µå‹™äººï¼Œæˆ‘å€‘å„²å­˜ä»–å€‘æ‡‰ä»˜çš„æ­£æ•¸é‡‘é¡
                    debtors.push({ name: member, amount: -balance }); 
                }
            }

            let i = 0; 
            let j = 0; 

            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];

                // è½‰å¸³é‡‘é¡æ˜¯å…©è€…ä¹‹é–“è¼ƒå°è€…ï¼Œä¸¦ä¸” **å››æ¨äº”å…¥å°æ•¸é»**
                // ç¢ºä¿è½‰å¸³é‡‘é¡æ˜¯æ•´æ•¸
                const transferAmount = Math.round(Math.min(debtor.amount, creditor.amount));

                if (transferAmount > 0) { // ç¢ºä¿æœ‰è‡³å°‘ 1 å…ƒçš„è½‰å¸³
                    settlements.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: transferAmount,
                    });
                }

                // 3. æ›´æ–°é¤˜é¡ (ä½¿ç”¨å¯¦éš›çš„æµ®é»æ•¸é€²è¡Œæ‰£é™¤ï¼Œä»¥ä¿æŒæ¸…ç®—é‚è¼¯æº–ç¢ºæ€§)
                debtor.amount -= transferAmount;
                creditor.amount -= transferAmount;

                // 4. ç§»å‹•æŒ‡é‡
                // åªæœ‰ç•¶å‰©é¤˜é¤˜é¡å°æ–¼ 1 æ™‚ï¼Œæˆ‘å€‘æ‰èªç‚ºè©²å¸³æˆ¶ã€ŒåŸºæœ¬ä¸Šã€çµæ¸…äº†ï¼ˆå› ç‚ºæˆ‘å€‘åªè™•ç†æ•´æ•¸è½‰å¸³ï¼‰
                if (debtor.amount < 1) { 
                    i++;
                }
                if (creditor.amount < 1) {
                    j++;
                }
            }
            
            return settlements;
          }, [calculateBalances]); // ä¾è³´æ–¼ calculateBalances çš„è¼¸å‡º

          // --- 7. UI è¼”åŠ©å…ƒä»¶ ---

          // è½‰æ› userId åˆ°é¡¯ç¤ºåç¨±
          const getDisplayName = (member) => member === userId ? 'æˆ‘ (You)' : member;
          
          // æ ¼å¼åŒ–æ™‚é–“æˆ³
          const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'ç„¡æ—¥æœŸ';
            // æª¢æŸ¥ timestamp æ˜¯å¦ç‚º Firestore Timestamp ç‰©ä»¶æˆ– Date ç‰©ä»¶
            const date = timestamp instanceof Date ? timestamp : (timestamp.toDate ? timestamp.toDate() : null);
            if (!date) return 'ç„¡æ—¥æœŸ';

            return date.toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: 'numeric',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            });
          };


          /**
           * é¡¯ç¤ºç•¶å‰ç”¨æˆ¶ IDï¼Œç”¨æ–¼åˆ†äº«
           */
          const CurrentUserDisplay = ({ userId }) => (
            <div className="text-xs bg-gray-100 p-2 rounded-lg break-all text-gray-500 mt-2">
              æ‚¨çš„ç”¨æˆ¶ IDï¼ˆè«‹åˆ†äº«æ­¤ ID çµ¦çµ„å“¡ï¼‰ï¼š
              <span className="font-mono font-bold text-gray-700 ml-1">{userId}</span>
            </div>
          );

          /**
           * æ”¯å‡ºåˆ—è¡¨å…ƒä»¶
           */
          const ExpenseList = () => {
            // æ ¹æ“š timestamp é€²è¡Œæ’åº (æ–°åˆ°èˆŠ)
            const sortedExpenses = useMemo(() => {
                return [...expenses].sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.getTime() : 0;
                    const timeB = b.timestamp ? b.timestamp.getTime() : 0;
                    return timeB - timeA; // é™åº (B - A = æ–°åˆ°èˆŠ)
                });
            }, [expenses]);
              
            return (
              <div className="mt-8">
                <h2 className="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                  <CircleDollarSign className="w-6 h-6 mr-2 text-primaryColor-500" />
                  æ‰€æœ‰æ”¯å‡º ({sortedExpenses.length})
                </h2>
                {sortedExpenses.length === 0 ? (
                  <p className="text-gray-500 italic p-4 bg-white rounded-xl shadow-inner">ç›®å‰æ²’æœ‰ä»»ä½•æ”¯å‡ºè¨˜éŒ„ã€‚</p>
                ) : (
                  <div className="space-y-4">
                    {sortedExpenses.map((exp) => {
                      const totalShares = Object.values(exp.shares).reduce((sum, s) => sum + s, 0);
                      const sharesDetail = Object.entries(exp.shares)
                        .filter(([, share]) => share > 0)
                        .map(([name, share]) => `${getDisplayName(name)} (${share}ä»½)`)
                        .join(', ');

                      return (
                        <div key={exp.id} className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-primaryColor-400 flex justify-between items-center transition duration-150 hover:shadow-xl">
                          <div className="flex-grow">
                            <p className="font-semibold text-lg text-gray-800">{exp.description}</p>
                            {/* é¡¯ç¤ºé‡‘é¡å››æ¨äº”å…¥ */}
                            <p className="text-3xl font-extrabold text-primaryColor-600 my-1">NT$ {Math.round(exp.amount).toFixed(0)}</p> 
                            <p className="text-sm text-gray-600">
                              <span className="font-medium text-primaryColor-700">ä»˜æ¬¾äºº:</span> {getDisplayName(exp.payerName)}
                            </p>
                            <p className="text-xs text-gray-500 mt-1">
                              <span className="font-medium">åˆ†å¸³:</span> {sharesDetail || 'ç„¡äººåˆ†å¸³'} (ç¸½ä»½æ•¸: {totalShares})
                            </p>
                            {/* é¡¯ç¤ºæ—¥æœŸæ™‚é–“ */}
                            <p className="text-xs text-gray-400 mt-1">
                              <span className="font-medium">æ™‚é–“:</span> {formatTimestamp(exp.timestamp)}
                            </p>
                          </div>
                          <div className="flex space-x-2">
                            <button
                              onClick={() => startEdit(exp)}
                              className="p-2 text-blue-500 hover:bg-blue-100 rounded-full transition duration-150"
                              aria-label="ç·¨è¼¯æ”¯å‡º"
                            >
                              <Pencil className="w-5 h-5" />
                            </button>
                            <button
                              onClick={() => deleteExpense(exp.id)}
                              disabled={isLoading}
                              className="p-2 text-red-500 hover:bg-red-100 rounded-full transition duration-150"
                              aria-label="åˆªé™¤æ”¯å‡º"
                            >
                              <Trash2 className="w-5 h-5" />
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            );
          };

          /**
           * é¤˜é¡ç¸½çµå…ƒä»¶ (é¡¯ç¤ºè½‰å¸³æ¸…å–®)
           */
          const BalanceSummary = () => {
            const settlements = calculateSettlements;
            const balances = calculateBalances;

            return (
              <div className="mt-8 p-6 bg-white rounded-xl shadow-2xl">
                <h2 className="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                  <Users className="w-6 h-6 mr-2 text-primaryColor-500" />
                  çµé¤˜ç¸½çµ (æ¸…ç®—æ–¹æ¡ˆ)
                </h2>

                {settlements.length === 0 ? (
                    <p className="text-lg font-medium text-green-600 p-3 bg-green-50 rounded-lg">ğŸ‰ æ‰€æœ‰å¸³ç›®å·²çµæ¸…ï¼</p>
                ) : (
                    <div className="space-y-4">
                        <p className="text-base text-gray-600 mb-4">ä»¥ä¸‹æ˜¯çµæ¸…å¸³ç›®æ‰€éœ€çš„è½‰å¸³æ¸…å–®ï¼ˆå››æ¨äº”å…¥ï¼‰ï¼š</p>
                        {settlements.map((settlement, index) => (
                            <div 
                                key={index} 
                                className="bg-yellow-50 p-4 rounded-xl shadow-md border-l-4 border-yellow-400 flex items-center"
                            >
                                <span className="font-bold text-yellow-800 text-xl mr-3">ğŸ’¸</span>
                                <div className="flex-grow text-gray-800">
                                    <p className="text-lg">
                                        <span className="font-bold text-red-600">{getDisplayName(settlement.from)}</span>
                                        <span className="mx-2 text-gray-500">æ‡‰ä»˜çµ¦</span>
                                        <span className="font-bold text-green-600">{getDisplayName(settlement.to)}</span>
                                    </p>
                                    {/* é¡¯ç¤ºè½‰å¸³é‡‘é¡å››æ¨äº”å…¥ */}
                                    <p className="text-3xl font-extrabold text-yellow-700 mt-1">
                                        NT$ {settlement.amount.toFixed(0)}
                                    </p>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                
                {/* åŸå§‹å€‹äººçµé¤˜åˆ—è¡¨ (ä¿ç•™ä½œç‚ºåƒè€ƒ) */}
                <div className="mt-6 pt-6 border-t border-gray-100">
                    <h3 className="text-xl font-semibold mb-3 text-gray-700">å€‹äººç¸½çµé¤˜ (åƒè€ƒ)</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {members.map(member => {
                            const balance = balances[member] || 0;
                            // å°æ–¼åƒè€ƒç”¨çš„å€‹äººçµé¤˜ï¼Œæˆ‘å€‘ä½¿ç”¨å››æ¨äº”å…¥ä¾†é¡¯ç¤º
                            const roundBalance = Math.round(balance); 
                            const isOwed = roundBalance > 0;
                            const isOwes = roundBalance < 0;
                            const displayMember = getDisplayName(member);

                            return (
                                <div 
                                    key={member} 
                                    className={`p-3 rounded-lg text-center ${isOwed ? 'bg-green-100' : isOwes ? 'bg-red-100' : 'bg-gray-100'}`}
                                >
                                    <p className="font-semibold truncate text-sm" title={displayMember}>{displayMember}</p>
                                    <p className={`text-xl font-bold mt-0.5 ${isOwed ? 'text-green-700' : isOwes ? 'text-red-700' : 'text-gray-500'}`}>
                                        {roundBalance.toFixed(0)}
                                    </p>
                                    <p className="text-xs text-gray-500">{isOwed ? 'æ‡‰æ”¶' : isOwes ? 'æ‡‰ä»˜' : 'çµæ¸…'}</p>
                                </div>
                            );
                        })}
                    </div>
                    <p className="mt-3 text-xs text-gray-500">æ­£æ•¸ (æ‡‰æ”¶): åˆ¥äººæ¬ ä½ ï¼›è² æ•¸ (æ‡‰ä»˜): ä½ æ¬ åˆ¥äººã€‚(é¡¯ç¤ºé‡‘é¡å·²å››æ¨äº”å…¥)</p>
                </div>
              </div>
            );
          };

          /**
           * æ”¯å‡º Modal (è™•ç†æ–°å¢å’Œç·¨è¼¯)
           */
          const ExpenseModal = () => {
            const isEditing = !!editingExpenseId;
            const modalTitle = isEditing ? 'ç·¨è¼¯æ”¯å‡ºè¨˜éŒ„' : 'æ–°å¢æ”¯å‡ºè¨˜éŒ„';
            const submitText = isEditing ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªæ–°å¢æ”¯å‡º';

            return (
              <div className={`fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity ${isExpenseModalOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl transform transition-transform duration-300 scale-100">
                  <div className="p-6 border-b flex justify-between items-center">
                    <h3 className="text-xl font-bold text-gray-800">{modalTitle}</h3>
                    <button onClick={closeExpenseModal} className="p-1 rounded-full hover:bg-gray-100 text-gray-600">
                      <X className="w-6 h-6" />
                    </button>
                  </div>

                  <div className="p-6 space-y-5">
                    {/* 1. å“é …èˆ‡é‡‘é¡ */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label htmlFor="description" className="block text-sm font-medium text-gray-700">å“é …/æè¿°</label>
                        <input
                          type="text"
                          id="description"
                          name="description"
                          value={newExpense.description}
                          onChange={handleInputChange}
                          placeholder="ä¾‹å¦‚: æ™šé¤ï¼Œé›»å½±ç¥¨"
                          className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                        />
                      </div>
                      <div>
                        <label htmlFor="amount" className="block text-sm font-medium text-gray-700">é‡‘é¡ (NT$)</label>
                        <input
                          type="number"
                          id="amount"
                          name="amount"
                          value={newExpense.amount}
                          onChange={handleInputChange}
                          placeholder="100.00"
                          className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                        />
                      </div>
                    </div>

                    {/* 2. ä»˜æ¬¾äºº */}
                    <div>
                      <label htmlFor="payerName" className="block text-sm font-medium text-gray-700">ä»˜æ¬¾äºº</label>
                      <select
                        id="payerName"
                        name="payerName"
                        value={newExpense.payerName}
                        onChange={handleInputChange}
                        className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500 bg-white"
                      >
                        {members.map(member => (
                          <option key={member} value={member}>
                            {getDisplayName(member)}
                          </option>
                        ))}
                      </select>
                    </div>

                    {/* 3. åˆ†å¸³ä»½æ•¸è¨­å®š */}
                    <div className="pt-4 border-t border-gray-100">
                      <div className="flex justify-between items-center mb-3">
                        <label className="text-lg font-bold text-gray-700">åˆ†å¸³ä»½æ•¸ (Shares)</label>
                        <button
                          onClick={setToAverageSplit}
                          type="button"
                          className="text-sm text-primaryColor-600 hover:text-primaryColor-800 font-medium"
                        >
                          [è¨­ç‚ºå¹³å‡åˆ†é…]
                        </button>
                      </div>
                      <div className="space-y-3 max-h-48 overflow-y-auto pr-2">
                        {members.map(member => {
                          const currentShares = newExpense.shares[member] || 0;
                          const displayMember = getDisplayName(member);
                          const isPayer = newExpense.payerName === member;

                          return (
                            <div key={member} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                              <span className={`font-medium ${isPayer ? 'text-primaryColor-700' : 'text-gray-700'}`}>
                                {displayMember} {isPayer && '(ä»˜æ¬¾äºº)'}
                              </span>
                              <div className="flex items-center space-x-2">
                                <button
                                  onClick={() => handleShareChange(member, -1)}
                                  type="button"
                                  className="p-1 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition"
                                  aria-label="æ¸›å°‘ä»½æ•¸"
                                >
                                  <Minus className="w-4 h-4" />
                                </button>
                                <span className="w-8 text-center font-bold text-lg text-gray-800">{currentShares}</span>
                                <button
                                  onClick={() => handleShareChange(member, 1)}
                                  type="button"
                                  className="p-1 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition"
                                  aria-label="å¢åŠ ä»½æ•¸"
                                >
                                  <Plus className="w-4 h-4" />
                                </button>
                                <span className="text-sm text-gray-500 w-8 text-right">ä»½</span>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>

                  <div className="p-6 border-t flex justify-end">
                    <button
                      onClick={saveExpense}
                      disabled={isLoading || newExpense.amount <= 0 || !newExpense.description}
                      className={`flex items-center px-6 py-3 rounded-full text-white font-semibold transition duration-150 shadow-md ${
                        isLoading || newExpense.amount <= 0 || !newExpense.description
                          ? 'bg-gray-400 cursor-not-allowed'
                          : `bg-${primaryColor}-600 hover:bg-${primaryColor}-700 hover:shadow-lg`
                      }`}
                    >
                      {isLoading ? 'å„²å­˜ä¸­...' : (
                        <>
                          <Check className="w-5 h-5 mr-2" />
                          {submitText}
                        </>
                      )}
                    </button>
                  </div>
                </div>
              </div>
            );
          };
          
          /**
           * æˆå“¡ç®¡ç† Modal
           */
          const MemberManagementModal = () => {
            // è‡¨æ™‚ç‹€æ…‹ï¼Œç”¨æ–¼åœ¨ Modal å…§ç·¨è¼¯é è¨­ä»½æ•¸
            const [tempDefaultShares, setTempDefaultShares] = useState({});

            useEffect(() => {
                if (isMemberModalOpen) {
                    // åˆå§‹åŒ– temp ç‹€æ…‹ï¼šåŒ…å«æ‰€æœ‰æˆå“¡ (åŒ…æ‹¬ userId) çš„ç•¶å‰é è¨­ä»½æ•¸
                    const initialShares = members.reduce((acc, name) => {
                        const shareValue = defaultSharesConfig[name] !== undefined ? defaultSharesConfig[name] : 1;
                        acc[name] = shareValue;
                        return acc;
                    }, {});
                    setTempDefaultShares(initialShares);
                }
            }, [isMemberModalOpen, members, defaultSharesConfig]);

            const handleTempShareChange = (name, value) => {
                const shareCount = parseInt(value, 10);
                // å…è¨±éè² æ•´æ•¸æˆ–ç©ºå­—ä¸²
                if (shareCount >= 0 || value === '') {
                    setTempDefaultShares(prev => ({
                        ...prev,
                        [name]: shareCount || 0
                    }));
                }
            };

            return (
              <div className={`fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity ${isMemberModalOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                  <div className="bg-white rounded-xl w-full max-w-2xl shadow-2xl transform transition-transform duration-300 scale-100">
                      <div className="p-6 border-b flex justify-between items-center">
                          <h3 className="text-xl font-bold text-gray-800">ç®¡ç†åˆ†å¸³æˆå“¡èˆ‡é è¨­ä»½æ•¸</h3>
                          <button onClick={() => setIsMemberModalOpen(false)} className="p-1 rounded-full hover:bg-gray-100 text-gray-600">
                              <X className="w-6 h-6" />
                          </button>
                      </div>
                      
                      <div className="p-6 space-y-6">
                          {/* æ–°å¢æˆå“¡ */}
                          <div className="border p-4 rounded-lg bg-gray-50">
                              <h4 className="font-semibold text-lg mb-3 flex items-center text-primaryColor-700">
                                  <UserPlus className="w-5 h-5 mr-2" /> æ–°å¢æˆå“¡
                              </h4>
                              <div className="flex space-x-2">
                                  <input
                                      type="text"
                                      value={newMemberName}
                                      onChange={(e) => setNewMemberName(e.target.value)}
                                      onKeyDown={(e) => e.key === 'Enter' && handleAddMember()}
                                      placeholder="è¼¸å…¥æ–°æˆå“¡åç¨± (ä¾‹å¦‚: å°æ˜)"
                                      className="flex-grow border border-gray-300 rounded-lg p-3 focus:ring-primaryColor-500 focus:border-primaryColor-500"
                                      disabled={isLoading}
                                  />
                                  <button
                                      onClick={handleAddMember}
                                      className={`px-4 py-2 rounded-lg text-white font-semibold transition ${
                                          newMemberName.trim() === '' || isLoading
                                          ? 'bg-gray-400 cursor-not-allowed'
                                          : `bg-${primaryColor}-600 hover:bg-${primaryColor}-700`
                                      }`}
                                      disabled={newMemberName.trim() === '' || isLoading}
                                  >
                                      æ–°å¢
                                  </button>
                              </div>
                          </div>

                          {/* ç¾æœ‰æˆå“¡åˆ—è¡¨ */}
                          <div>
                              <h4 className="font-semibold text-lg mb-3 text-gray-700">è¨­å®šæ‰€æœ‰æˆå“¡çš„é è¨­ä»½æ•¸</h4>
                              <div className="grid grid-cols-2 gap-x-4 gap-y-2 mb-3 text-sm font-semibold text-gray-600 border-b pb-2">
                                <span>æˆå“¡åç¨±</span>
                                <span className="flex items-center justify-between">é è¨­ä»½æ•¸ (1ç‚ºå¹³å‡åˆ†é…)</span>
                              </div>
                              <div className="space-y-2 max-h-64 overflow-y-auto pr-2">
                                  {members.map(member => (
                                      <div key={member} className="grid grid-cols-2 gap-4 items-center p-3 rounded-lg border border-gray-200 bg-white shadow-sm">
                                          <span className={`font-medium ${member === userId ? 'text-primaryColor-700' : 'text-gray-800'} truncate`}>
                                              {getDisplayName(member)}
                                          </span>
                                          <div className="flex items-center space-x-3">
                                            <input
                                                type="number"
                                                min="0"
                                                value={tempDefaultShares[member] === 0 ? 0 : tempDefaultShares[member] || 1}
                                                onChange={(e) => handleTempShareChange(member, e.target.value)}
                                                placeholder="1"
                                                className="w-16 border border-gray-300 rounded-lg p-2 text-center focus:ring-primaryColor-500 focus:border-primaryColor-500"
                                                disabled={isLoading}
                                            />
                                            <span className="text-gray-500">ä»½</span>
                                            {member !== userId && (
                                                <button
                                                    onClick={() => handleDeleteMember(member)}
                                                    className="p-1 text-red-500 hover:bg-red-100 rounded-full transition ml-auto"
                                                    disabled={isLoading}
                                                    aria-label="åˆªé™¤æˆå“¡"
                                                >
                                                    <UserMinus className="w-5 h-5" />
                                                </button>
                                            )}
                                          </div>
                                      </div>
                                  ))}
                              </div>
                          </div>
                      </div>
                      <div className="p-6 border-t flex justify-end">
                          <button
                              onClick={() => handleSaveDefaultShares(tempDefaultShares)}
                              disabled={isLoading}
                              className={`flex items-center px-6 py-3 rounded-full text-white font-semibold transition duration-150 shadow-md ${
                                  isLoading
                                  ? 'bg-gray-400 cursor-not-allowed'
                                  : `bg-${primaryColor}-600 hover:bg-${primaryColor}-700 hover:shadow-lg`
                              }`}
                          >
                              {isLoading ? 'å„²å­˜ä¸­...' : (
                                  <>
                                      <Check className="w-5 h-5 mr-2" />
                                      å„²å­˜é è¨­ä»½æ•¸
                                  </>
                              )}
                          </button>
                      </div>
                  </div>
              </div>
            );
          };


          // --- 8. ä¸»æ¸²æŸ“ ---
          if (!authReady) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <p className={`text-xl text-${primaryColor}-600`}>æ‡‰ç”¨ç¨‹å¼è¼‰å…¥ä¸­...</p>
              </div>
            );
          }

          if (error) {
            return (
              <div className="p-8 bg-red-100 border border-red-400 text-red-700 rounded-lg m-4">
                <p className="font-bold">ç™¼ç”ŸéŒ¯èª¤:</p>
                <p>{error}</p>
                <p className="mt-2 text-sm">è«‹æª¢æŸ¥æ‚¨çš„ Firebase è¨­å®šæˆ–ç¶²è·¯é€£ç·šã€‚</p>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
              <div className="max-w-4xl mx-auto">
                {/* æ¨™é¡Œå’Œä¸»è¦æ“ä½œæŒ‰éˆ• */}
                <header className="py-6 border-b border-gray-200">
                  <h1 className={`text-4xl font-extrabold text-${primaryColor}-700 flex items-center`}>
                    <CircleDollarSign className="w-10 h-10 mr-3" />
                    åˆ†å¸³è¨˜å¸³ç°¿
                  </h1>
                  <p className="text-gray-500 mt-1">è¼•é¬†è¨˜éŒ„åœ˜é«”æ”¯å‡ºï¼Œå…¬å¹³åˆ†é…è²»ç”¨ã€‚</p>
                  {userId && <CurrentUserDisplay userId={userId} />}
                </header>

                {/* ä¸»è¦åŠŸèƒ½å€å¡Š */}
                <div className="mt-6 flex space-x-4">
                  <button
                    onClick={startAdd}
                    className={`flex-1 flex items-center justify-center px-4 py-3 border border-transparent text-lg font-bold rounded-xl text-white bg-${primaryColor}-500 hover:bg-${primaryColor}-600 focus:outline-none focus:ring-4 focus:ring-${primaryColor}-300 transition duration-300 shadow-xl`}
                  >
                    <Plus className="w-6 h-6 mr-2" />
                    æ–°å¢æ”¯å‡º
                  </button>
                  <button
                    onClick={() => setIsMemberModalOpen(true)}
                    className={`px-4 py-3 border border-${primaryColor}-500 text-lg font-bold rounded-xl text-${primaryColor}-600 bg-white hover:bg-${primaryColor}-50 focus:outline-none focus:ring-4 focus:ring-${primaryColor}-300 transition duration-300 shadow-xl`}
                    aria-label="ç®¡ç†æˆå“¡èˆ‡é è¨­ä»½æ•¸"
                  >
                    <Users className="w-6 h-6" />
                  </button>
                </div>

                {/* ç¸½çµèˆ‡åˆ—è¡¨ */}
                <BalanceSummary />
                <ExpenseList />

                {/* Modal å€å¡Š */}
                <ExpenseModal />
                <MemberManagementModal />
              </div>

              {/* Tailwind color class fix, ensuring primaryColor is rendered */}
              <div className={`text-${primaryColor}-500 bg-${primaryColor}-500 border-${primaryColor}-500 hidden`}></div>
            </div>
          );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- å¼•å…¥ Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</body>
</html>