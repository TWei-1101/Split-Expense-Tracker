<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/TWei-1101/Split-Expense-Tracker/main/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/TWei-1101/Split-Expense-Tracker/main/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="192x192" href="https://raw.githubusercontent.com/TWei-1101/Split-Expense-Tracker/main/apple-touch-icon-192.png">
	<link rel="apple-touch-icon" sizes="250x250" href="https://raw.githubusercontent.com/TWei-1101/Split-Expense-Tracker/main/apple-touch-icon-250.png">
    <link rel="apple-touch-icon" sizes="512x512" href="https://raw.githubusercontent.com/TWei-1101/Split-Expense-Tracker/main/apple-touch-icon-512.png">
	<title>分帳記帳簿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        input[type='number'] { -moz-appearance: textfield; }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .force-gpu { transform: translateZ(0); will-change: transform; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primaryColor: {
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                        },
                    },
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script>
        const __app_id = "YOUR_APP_ID"; 
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyB8l7Od781kGHyI9pXMLBXvzt7NuuIyq8c",
            authDomain: "splite-expense-tracker.firebaseapp.com",
            projectId: "splite-expense-tracker",
            storageBucket: "splite-expense-tracker.firebasestorage.app",
            messagingSenderId: "425612895494",
            appId: "1:425612895494:web:b5889f1d83cafb41d7ea87",
            measurementId: "G-FVS0WSGZD9"
        });
        const GEMINI_API_KEY = ""; 
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    
    <script type="text/babel">
        const React = window.React;
        const { useState, useEffect, useCallback, useMemo } = React;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const { firestore } = firebase;
        const serverTimestamp = firestore.FieldValue.serverTimestamp; 

        // 儲存 Key 定義
        const PREFERRED_CURRENCY_KEY = "user_preferred_currency";

        const HARDCODED_DEFAULT_RATES = {
            'TWD': 1.0, 'CNY': 4.5, 'USD': 30.5, 'THB': 0.85, 'EUR': 33.0, 'CAD': 22.5,
            'VND': 0.0013, 'IDR': 0.002, 'JPY': 0.25, 'KRW': 0.023, 'AUD': 20.0, 'NOK': 2.9,
        };

        const CURRENCIES = Object.keys(HARDCODED_DEFAULT_RATES);
        const DEFAULT_CURRENCY = 'TWD';

        // --- 匯率獲取 ---
		const fetchExchangeRates = async () => {
			const CACHE_KEY = "exchangeRatesCache";
			const CACHE_TIME_KEY = "exchangeRatesCacheTime";
			const FOUR_HOURS = 4 * 60 * 60 * 1000;
			try {
				const cachedRates = localStorage.getItem(CACHE_KEY);
				const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
				if (cachedRates && cachedTime) {
					const lastUpdate = parseInt(cachedTime, 10);
					if (Date.now() - lastUpdate < FOUR_HOURS) {
						return { rates: JSON.parse(cachedRates), lastUpdate };
					}
				}
			} catch (err) {}
			try {
				const res = await fetch("https://open.er-api.com/v6/latest/TWD");
				const data = await res.json();
				const processedRates = { [DEFAULT_CURRENCY]: 1.0 };
				CURRENCIES.forEach(code => {
					if (code === DEFAULT_CURRENCY) return;
					processedRates[code] = data.rates[code] ? 1 / data.rates[code] : HARDCODED_DEFAULT_RATES[code];
				});
				const now = Date.now();
				localStorage.setItem(CACHE_KEY, JSON.stringify(processedRates));
				localStorage.setItem(CACHE_TIME_KEY, now.toString());
				return { rates: processedRates, lastUpdate: now };
			} catch (err) {
				return { rates: HARDCODED_DEFAULT_RATES, lastUpdate: Date.now() };
			}
		};

        // --- 圖標元件 ---
        const IconProps = { stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", fill: "none" };
        const CircleDollarSign = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>;
        const Trash2 = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const Plus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>;
        const Minus = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M5 12h14"></path></svg>;
        const Users = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
        const X = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>;
        const CircleCheck = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14 9 11"></polyline></svg>;
        const Pencil = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
        const LogOut = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>;
        const Share2 = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line><line x1="15.42" x2="8.59" y1="6.51" y2="10.49"></line></svg>;
        const Search = (props) => <svg {...props} {...IconProps} viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>;

        // --- 支出 Modal (已加入記憶邏輯) ---
        const ExpenseModal = React.memo(({ db, currentUserId, members, getInitialShares, state, onClose, getDisplayName, isReadOnly, collectionId, liveExchangeRates, defaultCurrency, currentUserLabel}) => {
            const [newExpense, setNewExpense] = useState({
                description: '',
                originalAmount: '',
                currency: DEFAULT_CURRENCY,
                payerName: currentUserId || '',
                shares: {}, 
            });
            const [isLoadingModal, setIsLoadingModal] = useState(false);
            const [modalError, setModalError] = useState(null);

            const isEditing = state.isEditing;
            const expenseToEdit = state.editingExpense;
            const submitText = isEditing ? '儲存修改' : '確認新增支出';
            
            const currentExchangeRate = liveExchangeRates[newExpense.currency] || HARDCODED_DEFAULT_RATES[newExpense.currency] || 1.0;
            const amountInTWD = useMemo(() => {
                const amount = parseFloat(newExpense.originalAmount) || 0;
                return amount * currentExchangeRate;
            }, [newExpense.originalAmount, currentExchangeRate]);

            useEffect(() => {
                if (state.isOpen) {
                    if (isEditing && expenseToEdit) {
                        const initialShares = members.reduce((acc, name) => ({ 
                            ...acc, [name]: expenseToEdit.shares[name] !== undefined ? expenseToEdit.shares[name] : 0 
                        }), {});
                        setNewExpense({
                            description: expenseToEdit.description,
                            originalAmount: expenseToEdit.originalAmount,
                            currency: expenseToEdit.currency || DEFAULT_CURRENCY,
                            payerName: expenseToEdit.payerName,
                            shares: initialShares,
                        });
					} else {
                      // ✨ 改動：優先讀取 localStorage
                      const savedCurrency = localStorage.getItem(PREFERRED_CURRENCY_KEY);
					  let defaultPayerId = (currentUserId && members.includes(currentUserId)) ? currentUserId : (members[0] || '');

					  setNewExpense({
						description: '',
						originalAmount: '',
						currency: savedCurrency || defaultCurrency || DEFAULT_CURRENCY, // 記憶 > GPS > TWD
						payerName: defaultPayerId,
						shares: getInitialShares(),
					  });
					}
                    setModalError(null);
                }
            }, [state.isOpen, isEditing, expenseToEdit, members, currentUserId, getInitialShares, defaultCurrency]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewExpense(prev => ({ ...prev, [name]: name === 'originalAmount' ? (value === '' ? '' : parseFloat(value) || '') : value }));
            };

            const handleCurrencyChange = (e) => {
                 const selected = e.target.value;
                 // ✨ 改動：儲存手動選擇
                 localStorage.setItem(PREFERRED_CURRENCY_KEY, selected);
                 setNewExpense(prev => ({ ...prev, currency: selected }));
            };

            const handleShareChange = (name, delta) => {
                setNewExpense(prev => {
                    const currentShares = prev.shares[name] || 0;
                    return { ...prev, shares: { ...prev.shares, [name]: Math.max(0, currentShares + delta) } };
                });
            };

            const saveExpense = async () => {
                if (isReadOnly || !db || !currentUserId) return;
                if (!newExpense.description.trim() || newExpense.originalAmount <= 0 || !newExpense.payerName) {
                    setModalError('請輸入有效的品項、金額和付款人！');
                    return;
                }
                setIsLoadingModal(true);
                try {
                    const expenseToSave = {
                        description: newExpense.description,
                        originalAmount: newExpense.originalAmount,
                        currency: newExpense.currency,
                        exchangeRate: currentExchangeRate,
                        amountInTWD: amountInTWD,
                        payerName: newExpense.payerName,
                        shares: Object.entries(newExpense.shares).reduce((acc, [name, share]) => { if (share > 0) acc[name] = share; return acc; }, {}),
                        ...(isEditing ? {} : { timestamp: serverTimestamp(), creatorId: currentUserId }),
                        appId: appId,
                    };
                    const collectionPath = `artifacts/${appId}/groups/${collectionId}/expenses`;
                    if (isEditing) { await db.doc(`${collectionPath}/${expenseToEdit.id}`).update(expenseToSave); }
                    else { await db.collection(collectionPath).add(expenseToSave); }
                    onClose();
                } catch (e) { setModalError(`儲存失敗: ${e.message}`); }
                finally { setIsLoadingModal(false); }
            };
            
            if (!state.isOpen) return null;

            return (
              <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-50 overflow-y-auto force-gpu">
                <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl my-4 flex flex-col force-gpu">
                  <div className="p-6 border-b flex justify-between items-center">
                    <h3 className="text-xl font-bold text-gray-800">{isEditing ? '編輯支出' : '新增支出'}</h3>
                    <button onClick={onClose} className="text-gray-600"><X className="w-6 h-6" /></button>
                  </div>
                  <div className="p-6 space-y-5 flex-1 overflow-y-auto">
                    {modalError && <p className="text-red-600 bg-red-100 p-3 rounded-lg text-sm">{modalError}</p>}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">品項</label>
                        <input type="text" name="description" value={newExpense.description} onChange={handleInputChange} className="mt-1 block w-full border rounded-lg p-3" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">金額</label>
                        <div className="flex space-x-2 mt-1">
                          <select name="currency" value={newExpense.currency} onChange={handleCurrencyChange} className="border rounded-lg p-3 bg-white">
                            {CURRENCIES.map(code => <option key={code} value={code}>{code}</option>)}
                          </select>
                          <input type="number" name="originalAmount" value={newExpense.originalAmount} onChange={handleInputChange} className="block w-full border rounded-lg p-3" />
                        </div>
                        {newExpense.originalAmount > 0 && <p className="mt-1 text-xs text-gray-500 italic">換算 TWD 約: {amountInTWD.toFixed(0)}</p>}
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">付款人</label>
                      <select name="payerName" value={newExpense.payerName} onChange={handleInputChange} className="mt-1 block w-full border rounded-lg p-3 bg-white">
                        {members.map(m => <option key={m} value={m}>{getDisplayName(m)}</option>)}
                      </select>
                    </div>
                    <div className="pt-4 border-t">
                      <label className="text-lg font-bold text-gray-700">分帳份數</label>
                      <div className="space-y-3 mt-3">
                        {members.map(member => (
                          <div key={member} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg border">
                            <span className="truncate">{getDisplayName(member)}</span>
                            <div className="flex items-center space-x-2">
                                <button onClick={() => handleShareChange(member, -1)} className="p-1 bg-red-50 text-red-600 rounded"><Minus className="w-5 h-5"/></button>
                                <span className="w-8 text-center font-bold">{newExpense.shares[member] || 0}</span>
                                <button onClick={() => handleShareChange(member, 1)} className="p-1 bg-green-50 text-green-600 rounded"><Plus className="w-5 h-5"/></button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
				  </div>
				  <div className="p-6 border-t flex justify-end">
					  <button onClick={saveExpense} disabled={isLoadingModal} className="bg-primaryColor-600 text-white px-6 py-3 rounded-full font-semibold">
					    {isLoadingModal ? '儲存中...' : '儲存'}
					  </button>
				    </div>
                </div>
              </div>
            );
        });

        // --- 主程式 App ---
        const App = () => {
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [userId, setUserId] = useState(null);
          const [authReady, setAuthReady] = useState(false);
          const [isGuest, setIsGuest] = useState(false);
          const [userProfiles, setUserProfiles] = useState({});
          const [liveExchangeRates, setLiveExchangeRates] = useState(HARDCODED_DEFAULT_RATES);
		  const [defaultCurrency, setDefaultCurrency] = useState(DEFAULT_CURRENCY);
          const [currentCollectionId, setCurrentCollectionId] = useState(null);
          const [expenses, setExpenses] = useState([]);
          const [members, setMembers] = useState([]);
          const [customMembers, setCustomMembers] = useState([]);
          const [defaultSharesConfig, setDefaultSharesConfig] = useState({});
          const [expenseModalState, setExpenseModalState] = useState({ isOpen: false, isEditing: false, editingExpense: null });

          useEffect(() => {
            const app = firebase.initializeApp(firebaseConfig);
            const _auth = app.auth();
            const _db = app.firestore();
            setDb(_db); setAuth(_auth);
            _auth.onAuthStateChanged(async (user) => {
                if (user) { setUserId(user.uid); setIsGuest(user.isAnonymous); setCurrentCollectionId(user.uid); }
                else { const anon = await _auth.signInAnonymously(); setUserId(anon.user.uid); setIsGuest(true); setCurrentCollectionId(anon.user.uid); }
                setAuthReady(true);
            });
            fetchExchangeRates().then(res => setLiveExchangeRates(res.rates));
          }, []);

          useEffect(() => {
            if (!db || !currentCollectionId) return;
            const unsubExp = db.collection(`artifacts/${appId}/groups/${currentCollectionId}/expenses`).onSnapshot(snap => {
                setExpenses(snap.docs.map(d => ({ id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate() })));
            });
            const unsubMem = db.doc(`artifacts/${appId}/groups/${currentCollectionId}/settings/members`).onSnapshot(doc => {
                if (doc.exists) { setCustomMembers(doc.data().list || []); setDefaultSharesConfig(doc.data().defaultShares || {}); }
            });
            return () => { unsubExp(); unsubMem(); };
          }, [db, currentCollectionId]);

          useEffect(() => {
            const m = [currentCollectionId, ...customMembers].filter((v, i, a) => v && a.indexOf(v) === i);
            setMembers(m);
          }, [currentCollectionId, customMembers]);

          const getDisplayName = useCallback((id) => userProfiles[id] || (id === userId ? '我' : id), [userProfiles, userId]);
          const getInitialShares = useCallback(() => members.reduce((acc, n) => ({ ...acc, [n]: defaultSharesConfig[n] ?? 1 }), {}), [members, defaultSharesConfig]);

          if (!authReady) return <div className="flex h-screen items-center justify-center">載入中...</div>;

		  return (
            <div className="min-h-screen bg-gray-50 p-4 sm:p-8 max-w-4xl mx-auto">
                <header className="py-6 border-b flex justify-between items-center">
                    <h1 className="text-3xl font-extrabold text-primaryColor-700">分帳記帳簿</h1>
                    <div className="text-right">
                        <p className="text-xs text-gray-500">預設幣別: {localStorage.getItem(PREFERRED_CURRENCY_KEY) || '自動'}</p>
                    </div>
                </header>

                <div className="mt-6 flex space-x-4">
                  <button onClick={() => setExpenseModalState({ isOpen: true, isEditing: false })} className="flex-1 bg-primaryColor-500 text-white p-4 rounded-xl shadow-lg flex items-center justify-center">
                    <Plus className="w-6 h-6 mr-2" /> 新增支出
                  </button>
                </div>

                <div className="mt-8 space-y-4">
                    {expenses.sort((a,b)=>b.timestamp-a.timestamp).map(exp => (
                        <div key={exp.id} className="bg-white p-4 rounded-xl shadow border-l-4 border-primaryColor-400 flex justify-between">
                            <div>
                                <p className="font-bold">{exp.description}</p>
                                <p className="text-2xl font-black text-primaryColor-600">{exp.currency} {exp.originalAmount}</p>
                                <p className="text-xs text-gray-400">{getDisplayName(exp.payerName)} 付款</p>
                            </div>
                        </div>
                    ))}
                </div>

                <ExpenseModal 
                    db={db} currentUserId={userId} members={members} getInitialShares={getInitialShares}
                    state={expenseModalState} onClose={() => setExpenseModalState({ isOpen: false })}
                    getDisplayName={getDisplayName} isReadOnly={false} collectionId={currentCollectionId}
                    liveExchangeRates={liveExchangeRates} defaultCurrency={defaultCurrency}
                />
            </div>
          );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
